# â­ æ ¹æ®å®é™…æƒ…å†µå¿…é¡»ä¿®æ”¹çš„åœ°æ–¹ - å¿«é€Ÿæ¸…å•

## ğŸ¯ 5ä¸ªå¿…é¡»ä¿®æ”¹çš„é…ç½®ï¼ˆ5åˆ†é’Ÿï¼‰

### 1ï¸âƒ£ æœåŠ¡å™¨æ•°é‡ â­â­â­â­â­

**ä½ç½®**: `gpu_resource_manager_v01.py` ç¬¬18è¡Œ

```python
TOTAL_SERVERS = 4    # â† æ”¹æˆä½ å®é™…æœ‰å‡ å°GPUæœåŠ¡å™¨
```

**ä¿®æ”¹ä¸º**:
- å¦‚æœä½ æœ‰2å°ï¼šæ”¹ä¸º `2`
- å¦‚æœä½ æœ‰8å°ï¼šæ”¹ä¸º `8`
- å¦‚æœä½ æœ‰Xå°ï¼šæ”¹ä¸º `X`

---

### 2ï¸âƒ£ æ¯å°GPUæ•°é‡ â­â­â­â­â­

**ä½ç½®**: `gpu_resource_manager_v01.py` ç¬¬19è¡Œ

```python
GPUS_PER_SERVER = 8    # â† æ”¹æˆæ¯å°æœåŠ¡å™¨æœ‰å‡ ä¸ªGPU
```

**ä¿®æ”¹ä¸º**:
- å¦‚æœæ¯å°4ä¸ªGPUï¼šæ”¹ä¸º `4`
- å¦‚æœæ¯å°16ä¸ªGPUï¼šæ”¹ä¸º `16`
- å¦‚æœæ¯å°Xä¸ªGPUï¼šæ”¹ä¸º `X`

---

### 3ï¸âƒ£ æ¯å°CPUæ•°é‡ â­â­â­â­

**ä½ç½®**: `gpu_resource_manager_v01.py` ç¬¬20è¡Œ

```python
CPUS_PER_SERVER = 64    # â† æ”¹æˆæ¯å°æœåŠ¡å™¨æœ‰å‡ ä¸ªCPU
```

**ä¿®æ”¹ä¸º**:
- å¦‚æœæ¯å°32ä¸ªCPUï¼šæ”¹ä¸º `32`
- å¦‚æœæ¯å°128ä¸ªCPUï¼šæ”¹ä¸º `128`
- å¦‚æœæ¯å°Xä¸ªCPUï¼šæ”¹ä¸º `X`

---

### 4ï¸âƒ£ Windowsé”æœºåˆ¶ â­â­â­â­ (ä»…Windowsç”¨æˆ·)

å¦‚æœä½ ç”¨çš„æ˜¯Windowsç³»ç»Ÿï¼Œ**å¿…é¡»ä¿®æ”¹**ï¼

#### æ–¹æ³•A: ä½¿ç”¨filelockï¼ˆæ¨èï¼‰

**æ­¥éª¤1**: å®‰è£…filelock
```bash
pip install filelock
```

**æ­¥éª¤2**: ä¿®æ”¹ `gpu_resource_manager_v01.py`

åœ¨æ–‡ä»¶å¼€å¤´ï¼ˆç¬¬7è¡Œé™„è¿‘ï¼‰æ·»åŠ ï¼š
```python
import sys
if sys.platform == 'win32':
    from filelock import FileLock, Timeout
else:
    import fcntl
```

åœ¨ `_acquire_lock` æ–¹æ³•ï¼ˆç¬¬75è¡Œï¼‰æ›¿æ¢ä¸ºï¼š
```python
def _acquire_lock(self, timeout: int = 60) -> Optional[object]:
    """è·å–æ–‡ä»¶é”ï¼ˆæ”¯æŒWindowsï¼‰"""
    if sys.platform == 'win32':
        # Windows - ä½¿ç”¨filelock
        try:
            lock = FileLock(self.LOCK_FILE, timeout=timeout)
            lock.acquire()
            return lock
        except Timeout:
            return None
    else:
        # Linux - ä½¿ç”¨fcntl
        lock_file = open(self.LOCK_FILE, 'w')
        start_time = time.time()
        
        while time.time() - start_time < timeout:
            try:
                fcntl.flock(lock_file.fileno(), fcntl.LOCK_EX | fcntl.LOCK_NB)
                return lock_file
            except IOError:
                time.sleep(0.1)
        
        lock_file.close()
        return None
```

åœ¨ `_release_lock` æ–¹æ³•ï¼ˆç¬¬93è¡Œï¼‰æ›¿æ¢ä¸ºï¼š
```python
def _release_lock(self, lock_file: object):
    """é‡Šæ”¾æ–‡ä»¶é”ï¼ˆæ”¯æŒWindowsï¼‰"""
    if lock_file:
        try:
            if sys.platform == 'win32':
                lock_file.release()
            else:
                fcntl.flock(lock_file.fileno(), fcntl.LOCK_UN)
                lock_file.close()
        except Exception as e:
            print(f"âš  é‡Šæ”¾é”æ—¶å‡ºé”™: {e}")
```

---

### 5ï¸âƒ£ GPUæ•°é‡é™åˆ¶ â­â­ (å¯é€‰ä½†å»ºè®®)

**ä½ç½®**: `gpu_resource_manager_v01.py` ç¬¬123è¡Œ

```python
if not (2 <= required_gpus <= 8):    # â† ä¿®æ”¹é™åˆ¶èŒƒå›´
```

**å»ºè®®ä¿®æ”¹ä¸º**:
```python
if not (1 <= required_gpus <= GPUS_PER_SERVER):
```

è¿™æ ·é™åˆ¶ä¼šè‡ªåŠ¨é€‚åº”ä½ çš„GPUé…ç½®ã€‚

---

## ğŸ“‹ å¿«é€Ÿä¿®æ”¹æ£€æŸ¥è¡¨

ä¿®æ”¹å®Œæˆåï¼Œå‹¾é€‰ä»¥ä¸‹é¡¹ç›®ï¼š

```
â–¡ å·²ä¿®æ”¹ TOTAL_SERVERSï¼ˆæœåŠ¡å™¨æ•°é‡ï¼‰
â–¡ å·²ä¿®æ”¹ GPUS_PER_SERVERï¼ˆGPUæ•°é‡ï¼‰
â–¡ å·²ä¿®æ”¹ CPUS_PER_SERVERï¼ˆCPUæ•°é‡ï¼‰
â–¡ Windowsç”¨æˆ·ï¼šå·²ä¿®æ”¹é”æœºåˆ¶
â–¡ å·²ä¿®æ”¹GPUé™åˆ¶èŒƒå›´ï¼ˆå¯é€‰ï¼‰

å®Œæˆåº¦ï¼š____/5
```

---

## âœ… éªŒè¯ä¿®æ”¹

ä¿®æ”¹å®Œæˆåï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯ï¼š

```bash
# 1. é‡æ–°åˆå§‹åŒ–
python cli_v01.py --reset --yes

# 2. æŸ¥çœ‹é…ç½®
python cli_v01.py --status

# 3. æ£€æŸ¥æ˜¯å¦æ­£ç¡®
# åº”è¯¥çœ‹åˆ°ä½ é…ç½®çš„æœåŠ¡å™¨æ•°é‡ã€GPUæ•°é‡ã€CPUæ•°é‡
```

**é¢„æœŸè¾“å‡ºç¤ºä¾‹**ï¼ˆå‡è®¾ä½ é…ç½®äº†2å°æœåŠ¡å™¨ï¼Œæ¯å°4GPUï¼Œ32CPUï¼‰ï¼š

```
GPUèµ„æºçŠ¶æ€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœåŠ¡å™¨      â”‚ GPUå¯ç”¨/æ€»æ•°â”‚ GPUåˆ©ç”¨ç‡â”‚ CPUå¯ç”¨/æ€»æ•°â”‚ CPUåˆ©ç”¨ç‡â”‚ è¿è¡Œä»»åŠ¡æ•° â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ gpu-server-0â”‚    4/4      â”‚   0.0%   â”‚   32/32     â”‚   0.0%   â”‚     0      â”‚
â”‚ gpu-server-1â”‚    4/4      â”‚   0.0%   â”‚   32/32     â”‚   0.0%   â”‚     0      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»è®¡:
  GPU: 8/8 å¯ç”¨         â† åº”è¯¥æ˜¯ 2*4=8
  CPU: 64/64 å¯ç”¨       â† åº”è¯¥æ˜¯ 2*32=64
  è¿è¡Œä»»åŠ¡: 0
```

---

## ğŸ¯ å®é™…ä¿®æ”¹ç¤ºä¾‹

### ç¤ºä¾‹1: æˆ‘æœ‰2å°æœåŠ¡å™¨ï¼Œæ¯å°4ä¸ªGPUï¼Œ32ä¸ªCPU

**ä¿®æ”¹**:
```python
# gpu_resource_manager_v01.py

TOTAL_SERVERS = 2        # æ”¹ä¸º 2
GPUS_PER_SERVER = 4      # æ”¹ä¸º 4
CPUS_PER_SERVER = 32     # æ”¹ä¸º 32
```

**éªŒè¯**:
```bash
python cli_v01.py --reset --yes
python cli_v01.py --status
# åº”è¯¥çœ‹åˆ°2å°æœåŠ¡å™¨ï¼Œæ€»å…±8ä¸ªGPUï¼Œ64ä¸ªCPU
```

---

### ç¤ºä¾‹2: æˆ‘æœ‰1å°æœåŠ¡å™¨ï¼ˆä¸ªäººç”µè„‘ï¼‰ï¼Œ2ä¸ªGPUï¼Œ16ä¸ªCPU

**ä¿®æ”¹**:
```python
# gpu_resource_manager_v01.py

TOTAL_SERVERS = 1        # æ”¹ä¸º 1
GPUS_PER_SERVER = 2      # æ”¹ä¸º 2
CPUS_PER_SERVER = 16     # æ”¹ä¸º 16
```

**åŒæ—¶ä¿®æ”¹GPUé™åˆ¶**:
```python
# ç¬¬123è¡Œ
if not (1 <= required_gpus <= 2):  # å…è®¸1-2ä¸ªGPU
    raise ValueError(...)
```

**éªŒè¯**:
```bash
python cli_v01.py --reset --yes
python cli_v01.py --status
# åº”è¯¥çœ‹åˆ°1å°æœåŠ¡å™¨ï¼Œ2ä¸ªGPUï¼Œ16ä¸ªCPU
```

---

## ğŸš¨ å¸¸è§é”™è¯¯

### é”™è¯¯1: ä¿®æ”¹åçŠ¶æ€ä¸å¯¹

**åŸå› **: æ—§çš„çŠ¶æ€æ–‡ä»¶è¿˜åœ¨

**è§£å†³**:
```bash
python cli_v01.py --reset --yes
```

### é”™è¯¯2: WindowsæŠ¥é”™ "No module named 'fcntl'"

**åŸå› **: Windowsä¸æ”¯æŒfcntl

**è§£å†³**: æŒ‰ç…§ç¬¬4æ­¥ä¿®æ”¹é”æœºåˆ¶

### é”™è¯¯3: æµ‹è¯•å¤±è´¥

**åŸå› **: æµ‹è¯•ç”¨ä¾‹ä¸­ç¡¬ç¼–ç äº†é…ç½®

**è§£å†³**: æš‚æ—¶å¿½ç•¥ï¼Œæˆ–ä¿®æ”¹ `test_v01.py` ä¸­çš„æœŸæœ›å€¼

---

## ğŸ“ è¿˜æœ‰é—®é¢˜ï¼Ÿ

### æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£
```bash
cat é…ç½®ä¿®æ”¹æŒ‡å—.md
```

### ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆæ›´ç®€å•ï¼‰
```bash
cat ä½¿ç”¨é…ç½®æ–‡ä»¶.md
```

### å¸¸è§é—®é¢˜
```bash
cat README_v01.md
```

---

## ğŸ‰ å®Œæˆï¼

ä¿®æ”¹å®Œè¿™5ä¸ªåœ°æ–¹åï¼Œä½ çš„GPUèµ„æºç®¡ç†å™¨å°±é…ç½®å¥½äº†ï¼

**ä¸‹ä¸€æ­¥**:
```bash
# æµ‹è¯•ä¸€ä¸‹
python cli_v01.py --allocate test_001 2 16
python cli_v01.py --status
python cli_v01.py --release test_001
```

---

**ğŸ’¡ æç¤º**: å¦‚æœä½ è§‰å¾—ä¿®æ”¹æºä»£ç éº»çƒ¦ï¼Œå¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶æ–¹å¼ï¼š

```bash
cp config_template.py config.py
vim config.py  # ä¿®æ”¹é…ç½®
python config.py  # éªŒè¯é…ç½®
```

è¯¦è§ï¼š`ä½¿ç”¨é…ç½®æ–‡ä»¶.md`

