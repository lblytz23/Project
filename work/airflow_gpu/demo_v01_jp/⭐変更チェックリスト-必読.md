# â­ å®Ÿéš›ã®çŠ¶æ³ã«å¿œã˜ã¦å¤‰æ›´ãŒå¿…è¦ãªç®‡æ‰€ - ã‚¯ã‚¤ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

## ğŸ¯ å¤‰æ›´ãŒå¿…è¦ãª5ã¤ã®è¨­å®šï¼ˆ5åˆ†ï¼‰

### 1ï¸âƒ£ ã‚µãƒ¼ãƒãƒ¼æ•° â­â­â­â­â­

**å ´æ‰€**: `gpu_resource_manager_v01.py` 18è¡Œç›®

```python
TOTAL_SERVERS = 4    # â† å®Ÿéš›ã®GPUã‚µãƒ¼ãƒãƒ¼å°æ•°ã«å¤‰æ›´
```

**å¤‰æ›´ä¾‹**:
- 2å°ã®å ´åˆï¼š`2` ã«å¤‰æ›´
- 8å°ã®å ´åˆï¼š`8` ã«å¤‰æ›´
- Xå°ã®å ´åˆï¼š`X` ã«å¤‰æ›´

---

### 2ï¸âƒ£ å„ã‚µãƒ¼ãƒãƒ¼ã®GPUæ•° â­â­â­â­â­

**å ´æ‰€**: `gpu_resource_manager_v01.py` 19è¡Œç›®

```python
GPUS_PER_SERVER = 8    # â† å„ã‚µãƒ¼ãƒãƒ¼ã®GPUæ•°ã«å¤‰æ›´
```

**å¤‰æ›´ä¾‹**:
- å„ã‚µãƒ¼ãƒãƒ¼4GPU ã®å ´åˆï¼š`4` ã«å¤‰æ›´
- å„ã‚µãƒ¼ãƒãƒ¼16GPU ã®å ´åˆï¼š`16` ã«å¤‰æ›´
- å„ã‚µãƒ¼ãƒãƒ¼XGPU ã®å ´åˆï¼š`X` ã«å¤‰æ›´

---

### 3ï¸âƒ£ å„ã‚µãƒ¼ãƒãƒ¼ã®CPUæ•° â­â­â­â­

**å ´æ‰€**: `gpu_resource_manager_v01.py` 20è¡Œç›®

```python
CPUS_PER_SERVER = 64    # â† å„ã‚µãƒ¼ãƒãƒ¼ã®CPUæ•°ã«å¤‰æ›´
```

**å¤‰æ›´ä¾‹**:
- å„ã‚µãƒ¼ãƒãƒ¼32CPU ã®å ´åˆï¼š`32` ã«å¤‰æ›´
- å„ã‚µãƒ¼ãƒãƒ¼128CPU ã®å ´åˆï¼š`128` ã«å¤‰æ›´
- å„ã‚µãƒ¼ãƒãƒ¼XCPU ã®å ´åˆï¼š`X` ã«å¤‰æ›´

---

### 4ï¸âƒ£ Windowsãƒ­ãƒƒã‚¯ãƒ¡ã‚«ãƒ‹ã‚ºãƒ  â­â­â­â­ (Windowsãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿)

Windowsã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€**å¤‰æ›´ãŒå¿…é ˆ**ã§ã™ï¼

#### æ–¹æ³•A: filelockã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰

**ã‚¹ãƒ†ãƒƒãƒ—1**: filelockã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
pip install filelock
```

**ã‚¹ãƒ†ãƒƒãƒ—2**: `gpu_resource_manager_v01.py` ã‚’å¤‰æ›´

ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ï¼ˆ7è¡Œç›®ä»˜è¿‘ï¼‰ã«è¿½åŠ ï¼š
```python
import sys
if sys.platform == 'win32':
    from filelock import FileLock, Timeout
else:
    import fcntl
```

`_acquire_lock` ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ75è¡Œç›®ï¼‰ã‚’ç½®æ›ï¼š
```python
def _acquire_lock(self, timeout: int = 60) -> Optional[object]:
    """ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯ã‚’å–å¾—ï¼ˆWindowså¯¾å¿œï¼‰"""
    if sys.platform == 'win32':
        # Windows - filelockã‚’ä½¿ç”¨
        try:
            lock = FileLock(self.LOCK_FILE, timeout=timeout)
            lock.acquire()
            return lock
        except Timeout:
            return None
    else:
        # Linux - fcntlã‚’ä½¿ç”¨
        lock_file = open(self.LOCK_FILE, 'w')
        start_time = time.time()
        
        while time.time() - start_time < timeout:
            try:
                fcntl.flock(lock_file.fileno(), fcntl.LOCK_EX | fcntl.LOCK_NB)
                return lock_file
            except IOError:
                time.sleep(0.1)
        
        lock_file.close()
        return None
```

`_release_lock` ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ93è¡Œç›®ï¼‰ã‚’ç½®æ›ï¼š
```python
def _release_lock(self, lock_file: object):
    """ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯ã‚’è§£æ”¾ï¼ˆWindowså¯¾å¿œï¼‰"""
    if lock_file:
        try:
            if sys.platform == 'win32':
                lock_file.release()
            else:
                fcntl.flock(lock_file.fileno(), fcntl.LOCK_UN)
                lock_file.close()
        except Exception as e:
            print(f"âš  ãƒ­ãƒƒã‚¯è§£æ”¾æ™‚ã«ã‚¨ãƒ©ãƒ¼: {e}")
```

---

### 5ï¸âƒ£ GPUæ•°åˆ¶é™ â­â­ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã ãŒæ¨å¥¨)

**å ´æ‰€**: `gpu_resource_manager_v01.py` 123è¡Œç›®

```python
if not (2 <= required_gpus <= 8):    # â† åˆ¶é™ç¯„å›²ã‚’å¤‰æ›´
```

**æ¨å¥¨å¤‰æ›´**:
```python
if not (1 <= required_gpus <= GPUS_PER_SERVER):
```

ã“ã‚Œã«ã‚ˆã‚Šã€åˆ¶é™ãŒGPUè¨­å®šã«è‡ªå‹•çš„ã«é©å¿œã—ã¾ã™ã€‚

---

## ğŸ“‹ ã‚¯ã‚¤ãƒƒã‚¯å¤‰æ›´ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

å¤‰æ›´å®Œäº†å¾Œã€ä»¥ä¸‹ã®é …ç›®ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š

```
â–¡ TOTAL_SERVERSï¼ˆã‚µãƒ¼ãƒãƒ¼æ•°ï¼‰ã‚’å¤‰æ›´æ¸ˆã¿
â–¡ GPUS_PER_SERVERï¼ˆGPUæ•°ï¼‰ã‚’å¤‰æ›´æ¸ˆã¿
â–¡ CPUS_PER_SERVERï¼ˆCPUæ•°ï¼‰ã‚’å¤‰æ›´æ¸ˆã¿
â–¡ Windowsãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãƒ­ãƒƒã‚¯ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’å¤‰æ›´æ¸ˆã¿
â–¡ GPUåˆ¶é™ç¯„å›²ã‚’å¤‰æ›´æ¸ˆã¿ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

å®Œæˆåº¦ï¼š____/5
```

---

## âœ… å¤‰æ›´ã®æ¤œè¨¼

å¤‰æ›´å®Œäº†å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§æ¤œè¨¼ï¼š

```bash
# 1. å†åˆæœŸåŒ–
python cli_v01.py --reset --yes

# 2. è¨­å®šã®ç¢ºèª
python cli_v01.py --status

# 3. æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
# è¨­å®šã—ãŸã‚µãƒ¼ãƒãƒ¼æ•°ã€GPUæ•°ã€CPUæ•°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãš
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹**ï¼ˆ2å°ã®ã‚µãƒ¼ãƒãƒ¼ã€å„4GPUã€32CPUã®å ´åˆï¼‰ï¼š

```
GPU ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ…‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚µãƒ¼ãƒãƒ¼    â”‚ GPUåˆ©ç”¨å¯/åˆè¨ˆâ”‚ GPUä½¿ç”¨ç‡ â”‚ CPUåˆ©ç”¨å¯/åˆè¨ˆâ”‚ CPUä½¿ç”¨ç‡ â”‚ å®Ÿè¡Œä¸­ã‚¿ã‚¹ã‚¯â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ gpu-server-0â”‚    4/4       â”‚   0.0%    â”‚   32/32      â”‚   0.0%    â”‚     0    â”‚
â”‚ gpu-server-1â”‚    4/4       â”‚   0.0%    â”‚   32/32      â”‚   0.0%    â”‚     0    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆè¨ˆ:
  GPU: 8/8 åˆ©ç”¨å¯èƒ½      â† 2*4=8ã«ãªã‚‹ã¯ãš
  CPU: 64/64 åˆ©ç”¨å¯èƒ½    â† 2*32=64ã«ãªã‚‹ã¯ãš
  å®Ÿè¡Œä¸­ã‚¿ã‚¹ã‚¯: 0
```

---

## ğŸ¯ å®Ÿéš›ã®å¤‰æ›´ä¾‹

### ä¾‹1: 2å°ã®ã‚µãƒ¼ãƒãƒ¼ã€å„4GPUã€32CPU

**å¤‰æ›´**:
```python
# gpu_resource_manager_v01.py

TOTAL_SERVERS = 2        # 2ã«å¤‰æ›´
GPUS_PER_SERVER = 4      # 4ã«å¤‰æ›´
CPUS_PER_SERVER = 32     # 32ã«å¤‰æ›´
```

**æ¤œè¨¼**:
```bash
python cli_v01.py --reset --yes
python cli_v01.py --status
# 2å°ã®ã‚µãƒ¼ãƒãƒ¼ã€åˆè¨ˆ8GPUã€64CPUãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãš
```

---

### ä¾‹2: 1å°ã®ã‚µãƒ¼ãƒãƒ¼ï¼ˆå€‹äººPCï¼‰ã€2GPUã€16CPU

**å¤‰æ›´**:
```python
# gpu_resource_manager_v01.py

TOTAL_SERVERS = 1        # 1ã«å¤‰æ›´
GPUS_PER_SERVER = 2      # 2ã«å¤‰æ›´
CPUS_PER_SERVER = 16     # 16ã«å¤‰æ›´
```

**GPUåˆ¶é™ã‚‚åŒæ™‚ã«å¤‰æ›´**:
```python
# 123è¡Œç›®
if not (1 <= required_gpus <= 2):  # 1-2GPUã‚’è¨±å¯
    raise ValueError(...)
```

**æ¤œè¨¼**:
```bash
python cli_v01.py --reset --yes
python cli_v01.py --status
# 1å°ã®ã‚µãƒ¼ãƒãƒ¼ã€2GPUã€16CPUãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãš
```

---

## ğŸš¨ ä¸€èˆ¬çš„ãªã‚¨ãƒ©ãƒ¼

### ã‚¨ãƒ©ãƒ¼1: å¤‰æ›´å¾Œã«çŠ¶æ…‹ãŒæ­£ã—ããªã„

**åŸå› **: å¤ã„çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ®‹ã£ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•**:
```bash
python cli_v01.py --reset --yes
```

### ã‚¨ãƒ©ãƒ¼2: Windowsã§ "No module named 'fcntl'" ã‚¨ãƒ©ãƒ¼

**åŸå› **: Windowsã¯fcntlã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**: ã‚¹ãƒ†ãƒƒãƒ—4ã«å¾“ã£ã¦ãƒ­ãƒƒã‚¯ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’å¤‰æ›´

### ã‚¨ãƒ©ãƒ¼3: ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹

**åŸå› **: ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«è¨­å®šãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•**: ä¸€æ™‚çš„ã«ç„¡è¦–ã™ã‚‹ã‹ã€`test_v01.py` ã®æœŸå¾…å€¤ã‚’å¤‰æ›´

---

## ğŸ“ ã¾ã å•é¡ŒãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ

### è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç¢ºèª
```bash
cat è¨­å®šå¤‰æ›´ã‚¬ã‚¤ãƒ‰.md
```

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½¿ç”¨ï¼ˆã‚ˆã‚Šç°¡å˜ï¼‰
```bash
cat è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½¿ç”¨.md
```

### ã‚ˆãã‚ã‚‹è³ªå•
```bash
cat README_v01.md
```

---

## ğŸ‰ å®Œäº†ï¼

ã“ã‚Œã‚‰5ç®‡æ‰€ã‚’å¤‰æ›´ã™ã‚Œã°ã€GPUãƒªã‚½ãƒ¼ã‚¹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®è¨­å®šå®Œäº†ã§ã™ï¼

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**:
```bash
# ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã¾ã—ã‚‡ã†
python cli_v01.py --allocate test_001 2 16
python cli_v01.py --status
python cli_v01.py --release test_001
```

---

**ğŸ’¡ ãƒ’ãƒ³ãƒˆ**: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒé¢å€’ãªå ´åˆã¯ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ–¹å¼ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š

```bash
cp config_template.py config.py
vim config.py  # è¨­å®šã‚’å¤‰æ›´
python config.py  # è¨­å®šã‚’æ¤œè¨¼
```

è©³ç´°ã¯ï¼š`è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½¿ç”¨.md` ã‚’å‚ç…§

