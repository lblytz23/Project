# 設定ファイルの使用方法

## 📋 クイックスタート

### ステップ1: 設定ファイルの作成

```bash
# テンプレートをコピー
cp config_template.py config.py

# 設定を編集
nano config.py  # または他のエディタを使用
```

### ステップ2: 設定の変更

`config.py` を開いて、以下の設定を変更：

```python
# サーバー設定（変更必須）
TOTAL_SERVERS = 2        # サーバー数に変更
GPUS_PER_SERVER = 4      # GPU数に変更
CPUS_PER_SERVER = 32     # CPU数に変更
```

### ステップ3: 設定の検証

```bash
python config.py
```

以下のように表示されるはず：
```
設定有効！✅
```

### ステップ4: 設定の使用

#### 方法A: 既存コードの変更（推奨）

`gpu_resource_manager_v01.py` の先頭に追加：

```python
# 設定ファイルのインポートを試行
try:
    from config import *
except ImportError:
    # デフォルト設定を使用
    TOTAL_SERVERS = 4
    GPUS_PER_SERVER = 8
    CPUS_PER_SERVER = 64
    RESOURCE_FILE = "resource_status.json"
    LOCK_FILE = ".resource.lock"
```

#### 方法B: 新しいアダプターの作成（より柔軟）

`gpu_manager_with_config.py` を作成：

```python
"""
設定ファイルを使用するGPUリソースマネージャー
"""

# 設定をインポート
from config import *
from gpu_resource_manager_v01 import GPUResourceManagerV01

# クラス属性を変更
GPUResourceManagerV01.TOTAL_SERVERS = TOTAL_SERVERS
GPUResourceManagerV01.GPUS_PER_SERVER = GPUS_PER_SERVER
GPUResourceManagerV01.CPUS_PER_SERVER = CPUS_PER_SERVER
GPUResourceManagerV01.RESOURCE_FILE = RESOURCE_FILE
GPUResourceManagerV01.LOCK_FILE = LOCK_FILE

# エクスポート
__all__ = ['GPUResourceManagerV01']

if __name__ == "__main__":
    print("設定がロードされました:")
    show_config()
    
    print("\nマネージャーを初期化中...")
    manager = GPUResourceManagerV01()
    
    print("状態を確認中...")
    summary = manager.get_resource_summary()
    print(f"総GPU数: {summary['total_gpus']}")
    print(f"総CPU数: {summary['total_cpus']}")
```

使用方法：

```python
# コード内で
from gpu_manager_with_config import GPUResourceManagerV01

manager = GPUResourceManagerV01()
```

---

## 🎯 設定例

### 例1: 小規模ラボ

```python
# config.py

# 2台のサーバー、各4GPU
TOTAL_SERVERS = 2
GPUS_PER_SERVER = 4
CPUS_PER_SERVER = 32

# ラボの命名を使用
def get_server_name(server_id):
    return f"lab-node-{server_id + 1}"

# シングルGPUタスクを許可
MIN_GPUS = 1
MAX_GPUS = 4
```

### 例2: 企業環境

```python
# config.py

# 8台の高性能サーバー
TOTAL_SERVERS = 8
GPUS_PER_SERVER = 8
CPUS_PER_SERVER = 128

# 固定ディレクトリを使用
import os
DATA_DIR = "/opt/gpu_manager/data"
RESOURCE_FILE = os.path.join(DATA_DIR, "resource_status.json")
LOCK_FILE = os.path.join(DATA_DIR, ".resource.lock")

# 実際のホスト名を使用
def get_server_name(server_id):
    return f"prod-gpu-{server_id + 1:02d}"

# 厳格な制限
MIN_GPUS = 2
MAX_GPUS = 8
```

### 例3: 混合設定

```python
# config.py

# カスタムサーバー設定を使用
TOTAL_SERVERS = 4

CUSTOM_SERVERS = [
    {"id": 0, "name": "training-gpu-01", "gpus": 8, "cpus": 128},
    {"id": 1, "name": "training-gpu-02", "gpus": 8, "cpus": 128},
    {"id": 2, "name": "dev-gpu-01",     "gpus": 4, "cpus": 64},
    {"id": 3, "name": "test-gpu-01",    "gpus": 2, "cpus": 32},
]
```

---

## ✅ 検証チェックリスト

設定完了後、確認：

```bash
# 1. 設定ファイルの検証
python config.py

# 2. システムの初期化
python cli_v01.py --reset --yes

# 3. 設定が正しいか確認
python cli_v01.py --status

# 4. 割り当てのテスト
python cli_v01.py --allocate test_001 2 16

# 5. 状態の検証
python cli_v01.py --detail

# 6. クリーンアップ
python cli_v01.py --release test_001
```

---

## 🐛 よくある質問

### Q: ImportError: No module named 'config'

**A**: `config.py` がスクリプトと同じディレクトリにあるか、Pythonパスに含まれていることを確認してください。

### Q: 設定を変更したが反映されない？

**A**: システムをリセットする必要があります：
```bash
python cli_v01.py --reset --yes
```

### Q: Windowsでロックエラー？

**A**: config.py を変更：
```python
LOCK_TYPE = 'filelock'
```

インストール：
```bash
pip install filelock
```

---

## 📝 完全なワークフロー

```bash
# 1. 設定テンプレートをコピー
cp config_template.py config.py

# 2. 設定を編集
vim config.py

# 3. 設定を検証
python config.py

# 4. システムをリセット（新しい設定を適用）
python cli_v01.py --reset --yes

# 5. 検証
python cli_v01.py --status

# 6. 使用開始
python cli_v01.py --allocate my_task 4 32
```

---

**ヒント**: 設定ファイルを使用すると、ソースコードを変更せずに異なる環境の設定を簡単に管理できます！

